#!/bin/bash
#
# run lttng-ust benchmark
#

: ${ITERS:=20}
: ${NR_EVENTS:=7000000}
: ${NR_CPUS:=1}

TIME="./ptime"

: ${PROG_NOTRACING:="./bench1 $NR_CPUS $NR_EVENTS"}
: ${PROG_TRACING:="./bench2 $NR_CPUS $NR_EVENTS"}

CMD_NOTRACING="$TIME '$PROG_NOTRACING >/dev/null 2>&1'"
CMD_TRACING="$TIME '$PROG_TRACING >/dev/null 2>&1'"

echo "lttng-ust benchmark"

rm -f result-*.txt average-*.txt perevent-*.txt

echo "using $NR_CPUS processor(s)"
echo "using $NR_EVENTS events per cpu"

echo "> running without tracing"
for i in $(seq $ITERS); do
	echo 3 >/proc/sys/vm/drop_caches
	t=$(sh -c "$CMD_NOTRACING")
	echo "$t" >> result-notracing.txt
	echo " time=$t sec"
done
./average <result-notracing.txt >average-notracing.txt

echo "> running with trace"

lttng-sessiond -d --no-kernel
lttng -q create
lttng -q enable-event -u -a
lttng -q start

for i in $(seq $ITERS); do
	echo 3 >/proc/sys/vm/drop_caches
	t=$(sh -c "$CMD_TRACING")
	echo "$t" >> result-tracing.txt
	echo " time=$t sec"
done
./average < result-tracing.txt > average-tracing.txt
echo "( $(< average-tracing.txt) - $(< average-notracing.txt) ) / $NR_EVENTS" | bc -l > perevent-tracing.txt

lttng -q stop
lttng -q destroy
